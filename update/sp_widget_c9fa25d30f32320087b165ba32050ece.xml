<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category/>
        <client_script><![CDATA[function($scope, $http, $location, $window) {
	var c = this;
	$scope.loading = false;
	$scope.search = "";
	$scope.hits = 0;
	$scope.codeSearch = function() {
		$scope.search = "code";
		$scope.loading = true;
		if ($scope.term) {
			$scope.hits = 0;
			var updateUrl = "/code"+"?q"+"=" + $scope.term;
			$window.history.pushState("", $scope.term, updateUrl);
			var searchGroup = "x_47329_code_searc.default";
			var endpoint = "/api/sn_codesearch/code_search/search?";
			endpoint += "search_group="+searchGroup+"&";
			endpoint += "term="+$scope.term+"&";
			endpoint += "search_all_scopes=true";
			$http.get(endpoint).success(function(response) {
				$scope.loading = false;
				$scope.results = response.result;
				$scope.results.map(function(table){
					table.hits.map(function(hit){
						$scope.hits++;
					});
				})
			});
		}
	}
	$scope.sysIdSearch = function() {
		$scope.search = "sysid";
		$scope.loading = true;
		if ($scope.term) {
			$scope.hits = 0;
			var updateUrl = "/code"+"?s"+"="+$scope.term;
			$window.history.pushState("", $scope.term, updateUrl);
			var searchGroup = "x_47329_code_searc.default";
			var endpoint = "/api/x_47329_code_searc/query?";
			endpoint += "sysid=" + $scope.term;//c661e7650f211300fc69cdbce1050e02
			$http.get(endpoint).success(function(response) {
				$scope.loading = false;
				$scope.results = response.result;
				//console.log($scope.results);
				$scope.results.map(function(hits){
					$scope.hits++;
				})
			});
		}
	}

	// Update to work with URL parameters
	if($location.search().q){
		$scope.term = $location.search().q;
		if($scope.term.length>0)
			$scope.codeSearch();
	}
	if($location.search().s){
		$scope.term = $location.search().s;
		if($scope.term.length>0)
			$scope.sysIdSearch();
	}
}]]></client_script>
        <controller_as>c</controller_as>
        <css>#spinner{
  font-size:10em;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>code_search_widget</id>
        <internal>false</internal>
        <link/>
        <name>Code Search Widget</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {  
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin_SHARE</sys_created_by>
        <sys_created_on>2017-05-23 09:02:53</sys_created_on>
        <sys_id>c9fa25d30f32320087b165ba32050ece</sys_id>
        <sys_mod_count>316</sys_mod_count>
        <sys_name>Code Search Widget</sys_name>
        <sys_package display_value="Code Search for SP" source="x_47329_code_searc">59ca65d30f32320087b165ba32050e30</sys_package>
        <sys_policy/>
        <sys_scope display_value="Code Search for SP">59ca65d30f32320087b165ba32050e30</sys_scope>
        <sys_update_name>sp_widget_c9fa25d30f32320087b165ba32050ece</sys_update_name>
        <sys_updated_by>jace.benson@protonmail.com</sys_updated_by>
        <sys_updated_on>2018-04-21 05:37:43</sys_updated_on>
        <template><![CDATA[<div class="panel panel-primary">
  <div class="panel-heading">
    <h3 class="panel-title">${Code Search}</h3>
  </div>
  <div class="panel-body col-12">
    <form>
      <div class="row">
        <div class="col-sm-8" style="display:flex;">
          <input id="search-term" type="text" placeholder="${Search term}" class="form-control" ng-model="term" /> 
        </div>
        <div class="col-sm-2">
          <button class="btn btn-primary" ng-click="codeSearch()">
            <i class="glyphicon glyphicon-search" aria-hidden="true"></i> Code
          </button>
        </div>
        <div class="col-sm-2">
          <button class="btn btn-danger" ng-click="sysIdSearch()">
            <i class="glyphicon glyphicon-search" aria-hidden="true"></i> Sysids
          </button>
        </div>
      </div><!-- /input-group -->
    </form>
  </div>
</div>
<div class="panel panel-default" ng-if="loading">
  <div class="text-center">
    <h1 ng-if="search==='code'">
      Searching code...  
    </h1>
    <h1 ng-if="search==='sysid'">
      Searching for record...  
    </h1>
    <div class="fa fa-spinner fa-spin" id="spinner"></div>
  </div>
</div>
<div class="panel panel-default" ng-if="results && !loading">
  <h1 class="text-center">
    <div ng-if="hits>0 && search === 'code'">
     {{hits}} Code Matches
    </div>
    <div ng-if="hits>0 && search === 'sysid'">
     Found
    </div>
    <div ng-if="hits === 0">
      No Matches Found
    </div>
  </h1>
  <div class="panel-body">
    
    <div ng-if="search==='sysid'" ng-repeat="hits in results">
      <div class="row container" id="{{hits.sysid}}">
        <p>
          <a href="{{hits.url}}">{{hits.displayValue}} on {{hits.table}}.</a>
        </p>
      </div>
    </div>
    <div ng-if="search==='code'" ng-repeat="table in results">
      <div class="row container" ng-if="table.hits.length>0">
        <p>
          <a href="#{{table.recordType}}">{{table.tableLabel}} has {{table.hits.length}} matching records.</a>
        </p>
      </div>
    </div>
    <div ng-repeat="table in results">
      <div class="row" id="{{table.recordType}}" ng-if="table.hits.length>0">
        <h1 class="text-center">
          {{table.tableLabel}}
        </h1>
      </div>
      <div class="row" ng-if="table.hits.length>0">
        <div class="row container" ng-repeat="hit in table.hits">
          <div class="col-sm-2">
            <a ng-href="{{hit.className}}.do?sys_id={{hit.sysId}}" target="_blank">{{hit.name}}</a>
          </div>
          <div class="col-sm-10">
            <div ng-repeat="match in hit.matches"> 
              <pre><code class="javascript"><span ng-repeat="context in match.lineMatches"><span>Line {{context.line}}</span>: <span>{{context.context}}</span><br/></span></code></pre> 
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
